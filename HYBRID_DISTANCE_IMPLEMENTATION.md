# Гибридная система расчета расстояний

## Обзор изменений

Реализован гибридный подход для расчета расстояний между городами:
1. **БД (city_distances)** — основной источник (быстро, надежно)
2. **OSRM API** — fallback для новых маршрутов (бесплатный, без лимитов)
3. **Автоматическое кеширование** — результаты API сохраняются в БД

## Преимущества

✅ **Производительность**: БД быстрее API  
✅ **Надежность**: работает без интернета для известных маршрутов  
✅ **Масштабируемость**: новые города автоматически получают расстояния через OSRM  
✅ **Гибкость**: админ может вручную корректировать расстояния через админ-панель  
✅ **Бесплатно**: OSRM публичный сервер без ограничений

## Что было добавлено

### 1. Модели БД

#### City — добавлены координаты
```python
latitude: Optional[float]   # широта
longitude: Optional[float]  # долгота
```

#### CityDistance — новая таблица
```python
from_city_id: int           # город отправления
to_city_id: int             # город назначения
distance_km: int            # расстояние в км
is_manual: bool             # ручное или из API
```

### 2. Провайдеры расстояний

#### `OSRMProvider`
Использует публичный OSRM API (`http://router.project-osrm.org`) для расчета автомобильных расстояний по координатам.

#### `HybridDistanceProvider`
1. Ищет расстояние в БД (прямое и обратное направление)
2. Если не найдено — запрашивает через OSRM API
3. Автоматически сохраняет результат в БД для будущих запросов

### 3. API Endpoints

#### Города (обновлено)
- `POST /api/v1/cities` — создание города с координатами
- `PUT /api/v1/cities/{id}` — обновление города (можно добавить/изменить координаты)

Пример:
```json
{
  "name": "Казань",
  "is_active": true,
  "latitude": 55.8304,
  "longitude": 49.0661
}
```

#### Расстояния (новое)
- `GET /api/v1/city-distances` — список всех расстояний
- `POST /api/v1/city-distances` — вручную добавить расстояние (админ)
- `PUT /api/v1/city-distances/{id}` — обновить расстояние (админ)
- `DELETE /api/v1/city-distances/{id}` — удалить расстояние (админ)

Пример создания расстояния:
```json
{
  "from_city_id": 1,
  "to_city_id": 5,
  "distance_km": 800,
  "is_manual": true
}
```

### 4. Миграция данных

Скрипт `seed.py` автоматически:
- Добавляет координаты для существующих городов (Москва, Сочи, СПб, Бишкек)
- Мигрирует данные из `offline_matrix.json` в таблицу `city_distances`

## Инструкция по применению

### 1. Установить зависимости
```bash
cd backend
source venv/bin/activate
pip install "httpx>=0.27"
```

### 2. Запустить БД (если не запущена)
```bash
docker-compose up -d db
```

### 3. Применить миграции
```bash
cd backend
source venv/bin/activate
alembic upgrade head
```

Миграции добавят:
- Поля `latitude`, `longitude` в таблицу `cities`
- Таблицу `city_distances`

### 4. Перезапустить backend
```bash
docker-compose restart backend
# или
make restart
```

При старте приложения автоматически:
- Обновятся координаты для существующих городов
- Данные из `offline_matrix.json` мигрируют в БД

### 5. Проверить работу

**Проверка существующих маршрутов:**
```bash
curl -X POST http://localhost:8000/api/v1/orders/preview \
  -H "Content-Type: application/json" \
  -d '{
    "from_city": "Москва",
    "to_city": "Сочи",
    "start_date": "2025-11-10"
  }'
```

**Добавить новый город через админ-панель:**
```json
{
  "name": "Казань",
  "is_active": true,
  "latitude": 55.8304,
  "longitude": 49.0661
}
```

**Проверить автоматический расчет расстояния:**
```bash
curl -X POST http://localhost:8000/api/v1/orders/preview \
  -H "Content-Type: application/json" \
  -d '{
    "from_city": "Москва",
    "to_city": "Казань",
    "start_date": "2025-11-10"
  }'
```

При первом запросе расстояние будет запрошено через OSRM и сохранено в БД. При повторных запросах — взято из БД.

## Как работает HybridDistanceProvider

```
┌─────────────────────────────────────────┐
│ Запрос расстояния Москва → Казань       │
└───────────────┬─────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│ Поиск в таблице city_distances          │
│ (прямое и обратное направление)         │
└───────────────┬─────────────────────────┘
                │
        ┌───────┴───────┐
        │               │
    Найдено        Не найдено
        │               │
        ▼               ▼
┌──────────────┐ ┌──────────────────────┐
│ Вернуть      │ │ Проверить координаты │
│ из БД        │ │ обоих городов        │
└──────────────┘ └──────┬───────────────┘
                        │
                ┌───────┴────────┐
                │                │
            Есть           Нет координат
                │                │
                ▼                ▼
        ┌──────────────┐  ┌────────────┐
        │ Запрос OSRM  │  │ Ошибка     │
        │ API          │  └────────────┘
        └──────┬───────┘
                │
                ▼
        ┌──────────────┐
        │ Сохранить в  │
        │ city_distances│
        └──────┬───────┘
                │
                ▼
        ┌──────────────┐
        │ Вернуть      │
        │ результат    │
        └──────────────┘
```

## Управление расстояниями через админ-панель

### Сценарий 1: Вручную добавить расстояние
Если админ знает точное расстояние или хочет переопределить автоматическое:
1. Перейти в раздел "Расстояния между городами"
2. Нажать "Добавить расстояние"
3. Выбрать города и указать расстояние
4. Установить флаг `is_manual=true`

### Сценарий 2: Добавить город без координат
Если нет координат, но есть расстояния до других городов:
1. Создать город без координат
2. Вручную добавить расстояния до других городов
3. При создании заказа будет использоваться БД

### Сценарий 3: Автоматический расчет
1. Создать город с координатами
2. При первом заказе OSRM автоматически рассчитает расстояние
3. Результат сохранится в БД для будущих заказов

## Примечания

### OSRM API
- Публичный сервер: `http://router.project-osrm.org`
- Бесплатный, без лимитов (fair use)
- Можно развернуть свой сервер при необходимости

### Координаты городов
Используются реальные координаты центров городов:
- Москва: 55.7558, 37.6173
- Сочи: 43.6028, 39.7342
- Санкт-Петербург: 59.9343, 30.3351
- Бишкек: 42.8746, 74.5698

### Производительность
- Запрос к БД: ~1-5 мс
- Запрос к OSRM API: ~100-500 мс (только при первом запросе)
- Последующие запросы: из БД (~1-5 мс)

## Frontend интеграция

### Обновить API клиент (admin)
```typescript
// api.ts
export interface CityDto {
  id: number;
  name: string;
  is_active: boolean;
  latitude?: number;
  longitude?: number;
}

export interface CityDistanceDto {
  id: number;
  from_city_id: number;
  to_city_id: number;
  distance_km: number;
  is_manual: boolean;
}

export const citiesApi = {
  // ... существующие методы
  
  async getCityDistances() {
    const res = await fetch(`${API_URL}/city-distances`);
    return res.json();
  },
  
  async createDistance(data: {
    from_city_id: number;
    to_city_id: number;
    distance_km: number;
    is_manual: boolean;
  }) {
    const res = await fetch(`${API_URL}/city-distances`, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(data)
    });
    return res.json();
  }
};
```

### Добавить страницу в админ-панель
Создать `AdminDistancesPage.tsx` для управления расстояниями между городами.

## Откат изменений

Если нужно откатить изменения:
```bash
cd backend
source venv/bin/activate
alembic downgrade -2
```

Откатятся миграции:
1. `e8e918e79aac` — удалит таблицу `city_distances`
2. `d1727ff6f90b` — удалит поля `latitude`, `longitude` из `cities`

## Тестирование

Запустить тесты:
```bash
cd backend
source venv/bin/activate
pytest app/tests/test_pricing.py -v
```

Тесты автоматически обновятся, т.к. используют интерфейс `DistanceProvider`.

